name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has-changesets: ${{ steps.check.outputs.found }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: check
        run: |
          if ls .changeset/*.md 2>/dev/null | grep -v README.md >/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "Changesets found - proceeding with release"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No changesets - skipping release"
          fi

      - uses: actions/setup-node@v4
        if: steps.check.outputs.found == 'true'
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        if: steps.check.outputs.found == 'true'
        run: npm ci --prefer-offline --no-audit

      - name: Lint
        if: steps.check.outputs.found == 'true'
        run: npm run lint

      - name: Type check
        if: steps.check.outputs.found == 'true'
        run: npm run typecheck

      - name: Security audit
        if: steps.check.outputs.found == 'true'
        run: npm audit --audit-level=high
        continue-on-error: true

  build:
    name: Build & Verify
    needs: pre-flight
    if: needs.pre-flight.outputs.has-changesets == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build packages
        run: npm run build

      - name: Verify build artifacts
        run: |
          required_files=(
            "packages/core/dist/index.cjs"
            "packages/core/dist/index.mjs"
            "packages/core/dist/index.d.ts"
            "packages/nextjs/dist/index.cjs"
            "packages/nextjs/dist/index.mjs"
            "packages/nextjs/dist/index.d.ts"
          )

          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done

      - name: Test package imports
        run: |
          node -e "const pkg = require('./packages/core/dist/index.cjs'); console.log('core:', Object.keys(pkg));"
          node -e "const pkg = require('./packages/nextjs/dist/index.cjs'); console.log('nextjs:', Object.keys(pkg));"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: packages/*/dist
          retention-days: 1

  release:
    name: Release & Publish
    needs: [pre-flight, build]
    if: needs.pre-flight.outputs.has-changesets == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      packages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          registry-url: https://registry.npmjs.org

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: packages

      - name: Version & Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: npm run version
          publish: npm run release
          title: 'chore: release packages'
          commit: 'chore: release packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Generate summary
        if: always()
        run: |
          {
            echo "## Release Summary"
            echo ""
            if [[ "${{ steps.changesets.outputs.published }}" == "true" ]]; then
              echo "**Status**: Packages published successfully"
              echo ""
              echo "### Published Packages"
              echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | "- \(.name)@\(.version)"'
            else
              echo "**Status**: Version PR created or updated"
            fi
          } >> $GITHUB_STEP_SUMMARY

  github-release:
    name: Create GitHub Releases
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create releases
        uses: actions/github-script@v7
        with:
          script: |
            const packages = JSON.parse('${{ needs.release.outputs.packages }}');
            const fs = require('fs');

            for (const pkg of packages) {
              const tag = `${pkg.name}@${pkg.version}`;
              const pkgName = pkg.name.replace('@siteline/', '');

              let changelog = `Release ${pkg.version}`;
              try {
                const content = fs.readFileSync(`packages/${pkgName}/CHANGELOG.md`, 'utf8');
                const versionRegex = new RegExp(`## ${pkg.version.replace(/\./g, '\\.')}[\\s\\S]*?(?=\\n## |$)`);
                const match = content.match(versionRegex);
                if (match) changelog = match[0];
              } catch (err) {
                console.log(`No CHANGELOG.md found for ${pkgName}`);
              }

              const body = `${changelog}

            ## Installation

            \`\`\`bash
            npm install ${pkg.name}@${pkg.version}
            \`\`\`

            ## Links

            - [npm package](https://www.npmjs.com/package/${pkg.name}/v/${pkg.version})
            - [Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/packages/${pkgName}#readme)`;

              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                body,
                prerelease: /alpha|beta|rc/i.test(pkg.version),
                generate_release_notes: true
              });

              console.log(`Created release for ${tag}`);
            }

  sbom:
    name: Generate SBOM
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate SBOM
        run: |
          for pkg in core nextjs; do
            cd "packages/$pkg"
            npm sbom --sbom-format=cyclonedx > "sbom-${pkg}.json"
            cd ../..
          done

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: packages/*/sbom-*.json
          retention-days: 90
